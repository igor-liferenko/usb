Proper steps to cleanup original Atmel's code:
1. github init avr-usb
2. md5sum of the usb-cdc archive (from ub0ali in 2 emails and from ub0ali in dropbox) - ensure that it is the same
3. unpack
4. git add
5. delete unused files (see git lg here - except flash_drv.s)
6. git st + check + git add
7. remove trailing \r from all files
8. git st + check + git add
9. git ci "initial import"
10. make it compile (fix usb_specific_request.c like this:
-extern U8   code *pbuffer;
+#ifdef __GNUC__
+  extern PGM_VOID_P pbuffer;
+#else
+  extern U8   code *pbuffer;
+#endif
)
11. configure (change "#define FOSC" to 16000 and "#define PLL_OUT_FRQ" to PLL_OUT_48MHZ and
"#define BAUDRATE" to 57600) + flash and check that it actually works (if it will not work - see
what else must be configured in commits up to commit "it is working now" here)
12. remove copyright
13. remove "#ifdef _GNUC_" to use avr-gcc
14. Do preprocessing of all .c files (to eliminate .h files and expand macros and remove #ifdef's)
use this:
cd ~/demo/
~/usb/mksurrogatehdr.sh `~/usb/listsyshdrs.sh`
avr-gcc -nostdinc -Dinclude=#include -I ~/demo/ -I ~/demo/demo/EVK527-ATMega32U4-usbdevice_cdc/conf/ -I ~/demo/demo/EVK527-ATMega32U4-usbdevice_cdc/ -I ~/demo/system-headers/ -E -P modules/usb/device_chap9/usb_device_task.c|sponge modules/usb/device_chap9/usb_device_task.c
Do this for every .c file and then remove all .h files.
Check "avr-objdump -d bin.elf" before and after - must be equal.
